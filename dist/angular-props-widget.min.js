// angular-props-widget v0.0.1
!function(a,b){"use strict";var c=function(a){return"[object Array]"===Object.prototype.toString.call(a)},d=function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])};b.module("ng").constant("PropsWidgetConfig",{iconlib:"bootstrap3",theme:"bootstrap3",disable_collapse:!0,disable_edit_json:!0,disable_properties:!0,disable_array_add:!0,disable_array_delete:!0,disable_array_reorder:!0,required_by_default:!0,sku_table_label_title:"SKU Table",sku_table_label_price:"Price",sku_table_label_stock:"Stock",sku_table_label_image:"Image"}).directive("propsWidget",["$q","PropsWidgetConfig",function(a,e){return{restrict:"E",transclude:!1,require:"ngModel",scope:{title:"@",schema:"=schema",value:"=ngModel",readonly:"=readonly",onChanged:"&ngChange"},link:function(f,g,h,i,j){if(!b.isString(h.schema))throw new Error("props-widget: schema attribute has to be defined.");var k=function(){var i,j=a.when({}),l=a.when(null);f.isValid=!1,f.isReady=!1,b.isObject(f.schema)&&(l=a.when(f.schema)),b.isObject(f.value)&&(i=f.value,j=a.when(b.isDefined(i.$promise)?i.$promise:i)),a.all([l,j]).then(function(a){var i=a[0].data||a[0],j=a[1];if(null===i)throw new Error("props-widget: could not resolve schema data.");f.title&&(i.title=f.title),b.extend(e,{startval:j,schema:i}),e.language&&(JSONEditor.defaults.language=e.language),f.editor=new JSONEditor(g[0],e);var l=f.editor;l.on("ready",function(){f.isValid=0===l.validate().length,f.isReady=!0,h.readonly&&l.disable(),f.unbindSchemaWatcher&&f.unbindSchemaWatcher(),f.unbindSchemaWatcher=f.$watch("schema",function(){f.isReady&&i!==f.schema&&(f.editor.destroy(),c(f.value)?f.value.length=0:f.value={},k())},!0),f.unbindValueWatcher&&f.unbindValueWatcher(),f.unbindValueWatcher=f.$watch("value",function(){f.isReady&&f.editor.setValue(f.value)},!0)}),l.on("change",function(){f.$apply(function(){if(f.isValid=0===l.validate().length,f.isValid){var a=l.getValue();d(f.value,a),f.onChanged&&f.onChanged()}})})})};k()}}}]).directive("skuTable",["$q","PropsWidgetConfig",function(a,e){var f=function(a){if(!a)return a;var b={},c,d=[];for(c in a)a.hasOwnProperty(c)&&d.push(c);for(d.sort(),c=0;c<d.length;c+=1)b[d[c]]=a[d[c]];return b},g=function(a){return a.reduce(function(a,b){var c=[];return a.forEach(function(a){b.forEach(function(b){c.push(a.concat([b]))})}),c},[[]])},h=function(a,b){var c=e.sku_table_label_title,d={type:"array",title:a||c,format:"table",uniqueItems:!0,items:{type:"object",properties:{}}};for(var f in b.properties)if(b.properties.hasOwnProperty(f)){var g=b.properties[f].items.type,h=b.properties[f].title;d.items.properties[f]={type:g,title:h,required:!0,readonly:!0}}return d.items.properties.price={type:"number",title:e.sku_table_label_price,required:!0},d.items.properties.stock={type:"number",title:e.sku_table_label_stock,required:!0},d.items.properties.image={type:"string",title:e.sku_table_label_image,media:{binaryEncoding:"base64",mediaType:"image/png"},required:!0},d},i=function(a){return a.map(function(a){a.skuProps=a.skuProps||{};for(var b=Object.keys(a.skuProps),c={price:a.price,stock:a.stock,image:a.image},d=0;d<b.length;d+=1){var e=b[d];c[e]=a.skuProps[e]}return c})},j=function(a){return a.map(function(a){for(var b=Object.keys(a),c={skuProps:{},price:a.price,stock:a.stock,image:a.image},d=0;d<b.length;d+=1){var e=b[d];"price"!==e&&"stock"!==e&&"image"!==e&&(c.skuProps[e]=a[e])}return c})};return{restrict:"E",transclude:!1,require:"ngModel",scope:{title:"@",schema:"=schema",skuProps:"=skuProps",value:"=ngModel",onChanged:"&ngChange"},link:function(k,l,m,n,o){if(!b.isString(m.schema))throw new Error("props-widget: schema attribute has to be defined.");var p=function(){var m,n=a.when({}),o=a.when(null);k.isValid=!1,k.isReady=!1,b.isObject(k.schema)&&(o=a.when(k.schema)),b.isObject(k.value)&&(m=k.value,n=a.when(b.isDefined(m.$promise)?m.$promise:m)),a.all([o,n]).then(function(a){var m=a[0].data||a[0],n=a[1];if(null===m)throw new Error("props-widget: could not resolve schema data.");var o=h(k.title,m),q=i(n);b.extend(e,{startval:q,schema:o}),e.language&&(JSONEditor.defaults.language=e.language),k.editor=new JSONEditor(l[0],e);var r=k.editor;r.on("ready",function(){k.isValid=0===r.validate().length,k.isReady=!0,k.unbindSchemaWatcher&&k.unbindSchemaWatcher(),k.unbindSchemaWatcher=k.$watch("schema",function(){k.isReady&&m!==k.schema&&(k.editor.destroy(),c(k.value)?k.value.length=0:k.value={},p())}),k.unbindValueWatcher&&k.unbindValueWatcher(),k.unbindValueWatcher=k.$watch("value",function(){if(k.isReady){var a=i(k.value);k.editor.setValue(a)}},!0),k.unbindSkuPropsWatcher&&k.unbindSkuPropsWatcher(),k.unbindSkuPropsWatcher=k.$watch("skuProps",function(a){if(k.isReady){for(var b,c,d=Object.keys(k.skuProps),e=[],h=0;h<d.length;h+=1){b=d[h];var i=k.skuProps[b];e.push(i)}var j=g(e),l=k.value.slice(0);k.value.length=0,j.forEach(function(a){for(var e={skuProps:{},price:0,stock:0,image:""},g=0;g<d.length;g+=1)b=d[g],c=a[g],e.skuProps[b]=c;if(e.skuProps=f(e.skuProps),l)for(var h=0;h<l.length;h+=1){var i=l[h];if(_.isEqual(e.skuProps,i.skuProps)){e.price=i.price,e.stock=i.stock,e.image=i.image;break}}k.value.push(e)})}},!0)}),r.on("change",function(){k.$apply(function(){if(k.isValid=0===r.validate().length,k.isValid){var a=r.getValue(),b=j(a);d(k.value,b),k.onChanged&&k.onChanged()}})})})};p()}}}]),JSONEditor.defaults.languages.zh={error_notset:"属性必须设置",error_notempty:"必须值",error_enum:"值必须是枚举值之一",error_anyOf:"值必须是通过提供的Schema之一的校验",error_oneOf:"值必须是仅通过提供的一个Schema之一的校验。它当前通过{{0}}个Schema的校验",error_not:"值必须不能通过提供的Schema验证",error_type_union:"值必须试提供的类型之一",error_type:"值必须是{{0}}类型的",error_disallow_union:"值必须不能是禁止类型之一",error_disallow:"值必须不能是{{0}}类型的",error_multipleOf:"值必须是{{0}}类型数组",error_maximum_excl:"值必须小于{{0}}",error_maximum_incl:"值最大为{{0}}",error_minimum_excl:"值必须大于{{0}}",error_minimum_incl:"值必须最小{{0}}",error_maxLength:"值必须最多{{0}}个字符长",error_minLength:"值必须最少{{0}}个字符长",error_pattern:"值必须匹配提供的模式",error_additionalItems:"这个数组不允许添加额外的元素",error_maxItems:"值必须最多{{0}}项",error_minItems:"值必须最少{{0}}项",error_uniqueItems:"数组元素必须唯一",error_maxProperties:"对象必须最多{{0}}个属性",error_minProperties:"对象必须最少{{0}}个属性",error_required:"对象缺少必须属性{{0}}",error_additional_properties:"不允许额外属性，但属性{{0}}已经设置",error_dependency:"必须有{{0}}属性"}}(window,angular);